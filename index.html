<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALMO</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --platform-bg: #f4f4f9;
            --button-color: #007bff;
            --button-hover-color: #0057a3;
            --header-bg: #ffffff;
            --cart-button-bg: #e0f7fa;
            --cart-button-hover-bg: #b3e5fc;
            --footer-bg: linear-gradient(180deg, #007bff, #0057a3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--platform-bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }

        header {
            background: var(--header-bg);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .menu-btn,
        .cart-btn,
        .chatbot-btn {
            background: #fff;
            border: none;
            padding: 8px;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s;
            position: relative;
            touch-action: manipulation;
        }

        .cart-btn {
            background: var(--cart-button-bg);
        }

        .cart-btn:hover,
        .cart-btn.active {
            background: var(--cart-button-hover-bg);
            transform: scale(1.1);
        }

        .menu-btn:hover,
        .chatbot-btn:hover {
            transform: scale(1.1);
        }

        .menu-btn i,
        .cart-btn i,
        .chatbot-btn i {
            font-size: 24px;
            color: #333;
            transition: color 0.3s;
        }

        .menu-btn:hover i,
        .cart-btn:hover i,
        .cart-btn.active i,
        .chatbot-btn:hover i {
            color: var(--button-color);
        }

        .cart-count {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #e91e63;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-section {
            display: flex;
            flex-direction: row;
            gap: 10px;
            padding: 15px 20px;
            align-items: center;
            justify-content: flex-start;
            max-width: 1200px;
            margin: 0 auto;
        }

        .search-section input {
            width: 300px;
            padding: 10px;
            border: 1px solid #bbb;
            border-radius: 8px;
            font-size: 16px;
        }

        .catalog-btn {
            background: var(--button-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .catalog-btn:hover {
            background: var(--button-hover-color);
        }

        .products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            padding: 20px;
        }

        .product {
            display: flex;
            flex-direction: column;
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .product:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .product img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .product h4 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #333;
        }

        .product p {
            font-weight: 700;
            color: #e91e63;
            font-size: 14px;
            margin: 5px 0;
        }

        .product button {
            background: var(--button-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            margin-top: auto;
            transition: background 0.3s;
        }

        .product button.add-to-cart:hover {
            background: var(--button-hover-color);
        }

        .quantity-selector {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: auto;
        }

        .quantity-selector.active {
            display: flex;
        }

        .quantity-selector button {
            background: var(--button-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
        }

        .quantity-selector button:hover {
            background: var(--button-hover-color);
        }

        .cart-form,
        .product-modal,
        .image-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .cart-form.active,
        .product-modal.active,
        .image-modal.active {
            display: block;
        }

        .cart-items {
            margin: 10px 0;
            max-height: 150px;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .cart-form button,
        .product-modal button,
        .image-modal button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
        }

        .cart-form .submit-btn,
        .product-modal .submit-btn {
            background: var(--button-color);
            color: white;
        }

        .cart-form .close-btn,
        .product-modal .close-btn,
        .image-modal .close-btn {
            background: #dc3545;
            color: white;
        }

        .cart-form input,
        .cart-form select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #bbb;
            border-radius: 6px;
        }

        .cart-form .input-wrap {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .cart-form .input-wrap input {
            padding: 16px;
            font-size: 1.1rem;
            width: 100%;
            border: 2px solid #ccc;
            border-radius: 10px;
        }

        #map {
            height: 300px;
            width: 100%;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--button-color);
        }

        .payment-section {
            margin-top: 20px;
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .payment-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-option:hover {
            border-color: var(--button-color);
            background: #f0f6ff;
        }

        .payment-option input[type="radio"] {
            margin-right: 12px;
            accent-color: var(--button-color);
            width: 18px;
            height: 18px;
        }

        .payment-option span {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .payment-option input[type="radio"]:checked+span {
            color: var(--button-color);
            font-weight: 600;
        }

        .payment-option.cash {
            background: #e8f5e9;
            border-color: var(--button-color);
        }

        .payment-option.card {
            background: #e3f2fd;
            border-color: var(--button-color);
        }

        .payment-option.credit {
            background: #fff3e0;
            border-color: var(--button-color);
        }

        .payment-details {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .payment-details.active {
            display: block;
        }

        .payment-details input {
            margin-bottom: 10px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        #creditNextBtn {
            background: var(--button-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            margin-top: 15px;
            width: 100%;
            max-width: 200px;
        }

        #creditNextBtn:hover {
            background: var(--button-hover-color);
        }

        .cart-form label,
        .product-modal label {
            font-weight: 500;
            margin-top: 10px;
            display: block;
            color: #333;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .receipt-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1003;
            width: 90%;
            max-width: 400px;
        }

        .receipt-modal.active {
            display: block;
        }

        .chatbot-container {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            height: 470px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1006;
            flex-direction: column;
        }

        .chatbot-container.active {
            display: flex;
        }

        .chatbot-header {
            background: var(--button-color);
            color: white;
            padding: 10px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbot-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }

        .chatbot-message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 6px;
            font-size: 14px;
            animation: fadeIn 0.3s ease-in;
        }

        .chatbot-message.user {
            background: #e0f7fa;
            margin-left: 20%;
            text-align: right;
            border-right: 4px solid var(--button-color);
        }

        .chatbot-message.bot {
            background: #f5f5f5;
            margin-right: 20%;
            border-left: 4px solid var(--button-color);
        }

        .chatbot-message img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 5px;
        }

        .chatbot-input {
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-top: 1px solid #ddd;
        }

        .chatbot-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #bbb;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .chatbot-input button {
            background: var(--button-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        .sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #333;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
            z-index: 1001;
        }

        .settings-sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            top: 0;
            right: 0;
            background-color: #fff;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
            z-index: 1001;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.15);
        }

        .sidebar a,
        .settings-sidebar a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 18px;
            color: #f1f1f1;
            display: block;
            transition: 0.3s;
        }

        .settings-sidebar a {
            color: #333;
        }

        .sidebar a:hover,
        .settings-sidebar a:hover {
            color: var(--button-color);
        }

        .sidebar .close-btn,
        .settings-sidebar .close-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 36px;
            cursor: pointer;
            color: #f1f1f1;
        }

        .settings-sidebar .close-btn {
            color: #333;
        }

        .sidebar hr,
        .settings-sidebar hr {
            border: 0;
            height: 1px;
            background: #f1f1f1;
            margin: 8px 32px;
        }

        .settings-sidebar hr {
            background: #ddd;
        }

        .category-content {
            display: none;
        }

        .category-content.active {
            display: block;
        }

        .back-button {
            display: none;
            margin: 15px 20px;
            padding: 8px 15px;
            background: var(--button-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .back-button.active {
            display: block;
        }

        .settings-sidebar-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .settings-sidebar-content select,
        .settings-sidebar-content input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #bbb;
            border-radius: 6px;
            font-size: 14px;
        }

        .settings-sidebar-content button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }

        .settings-sidebar-content .submit-btn {
            background: var(--button-color);
            color: white;
        }

        .settings-sidebar-content .close-btn {
            background: #dc3545;
            color: white;
        }

        .settings-sidebar-content label {
            font-weight: 500;
            margin-top: 10px;
            display: block;
            color: #333;
        }

        .settings-sidebar-content .category-link {
            cursor: pointer;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: background 0.3s;
        }

        .settings-sidebar-content .category-link:hover {
            background: #e0f7fa;
        }

        .settings-sidebar-content .back-arrow {
            display: none;
            font-size: 24px;
            cursor: pointer;
            color: #333;
            margin-bottom: 10px;
        }

        .settings-sidebar-content .back-arrow.active {
            display: block;
        }

        .color-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .color-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-option:hover {
            border-color: var(--button-color);
            background: #f0f6ff;
        }

        .color-option input[type="radio"] {
            margin-right: 12px;
            accent-color: var(--button-color);
            width: 18px;
            height: 18px;
        }

        .color-option span {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 12px;
            border: 1px solid #ccc;
        }

        .color-option input[type="radio"]:checked + span {
            border: 2px solid var(--button-color);
        }

        .header-color-options,
        .cart-color-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .header-color-option,
        .cart-color-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-color-option:hover,
        .cart-color-option:hover {
            border-color: var(--button-color);
            background: #f0f6ff;
        }

        .header-color-option input[type="radio"],
        .cart-color-option input[type="radio"] {
            margin-right: 12px;
            accent-color: var(--button-color);
            width: 18px;
            height: 18px;
        }

        .header-color-option span,
        .cart-color-option span {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 12px;
            border: 1px solid #ccc;
        }

        .header-color-option input[type="radio"]:checked + span,
        .cart-color-option input[type="radio"]:checked + span {
            border: 2px solid var(--button-color);
        }

        footer {
            background: var(--footer-bg);
            padding: 20px;
            text-align: center;
            font-size: 14px;
            color: white;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .footer-logo {
            margin-bottom: 10px;
        }

        .footer-logo h2 {
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: -10px;
        }

        .footer-links a {
            font-size: 14px;
            color: white;
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: #b3e5fc;
        }

        .footer-contact {
            margin: 10px 0;
            font-size: 14px;
        }

        .footer-contact p {
            margin: 5px 0;
            color: white;
        }

        hr {
            margin: 10px;
            margin-bottom: -15px;
            justify-content: center;
            width: 100%;
            max-width: 2000px;
            border: 0;
            height: 1.5px;
            background: #b3e5fc;
        }

        .otasi {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 30px;
        }

        .footer-copyright {
            font-size: 12px;
            color: white;
        }

        .footerr a {
            font-size: 14px;
            color: white;
            text-decoration: none;
        }

        .footerr a:hover {
            color: #b3e5fc;
        }

        .product-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .product-images img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .product-images img:hover {
            transform: scale(1.05);
        }

        .image-modal img {
            width: 100%;
            max-width: 500px;
            height: auto;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 600px) {
            .chatbot-container {
                width: 90%;
                height: 80%;
                right: 5%;
                bottom: 10px;
            }

            .header-buttons {
                display: flex;
                justify-content: flex-end;
                align-items: center;
                gap: 8px;
                margin-right: 10px;
                width: 100%;
            }

            .logo {
                font-size: 18px;
                flex-shrink: 0;
            }

            .otasi {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }

            .footerr {
                margin: 0;
            }

            .footer-links {
                flex-direction: column;
                gap: 10px;
            }

            .footer-content {
                padding: 10px;
            }

            .footer-logo h2 {
                font-size: 20px;
            }

            .footer-contact p {
                font-size: 12px;
            }

            .footer-copyright {
                font-size: 11px;
            }

            .products {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 10px;
            }

            .search-section {
                flex-direction: row;
                gap: 5px;
                justify-content: center;
                padding: 10px 15px;
                flex-wrap: wrap;
            }

            .search-section input {
                width: 100%;
                max-width: 200px;
                font-size: 14px;
            }

            .catalog-btn {
                width: auto;
                padding: 8px 12px;
                font-size: 14px;
            }

            .product-images img {
                width: 100px;
                height: 100px;
            }

            .image-modal img {
                max-width: 90%;
            }

            #map {
                height: 250px;
            }

            .menu-btn,
            .cart-btn,
            .chatbot-btn {
                padding: 6px;
            }

            .menu-btn i,
            .cart-btn i,
            .chatbot-btn i {
                font-size: 20px;
            }

            .cart-count {
                width: 16px;
                height: 16px;
                font-size: 10px;
            }

            select {
                font-size: 14px;
                padding: 6px;
            }

            .payment-option {
                padding: 10px;
            }

            .payment-option span {
                font-size: 14px;
            }

            #creditNextBtn {
                padding: 10px 20px;
                font-size: 14px;
                max-width: 180px;
            }

            .settings-sidebar {
                width: 0;
                padding-top: 40px;
            }

            .settings-sidebar.active {
                width: 80%;
            }
        }

        select {
            color: rgb(14, 14, 14);
            border-radius: 10px;
            font-size: 15px;
            padding: 5px;
        }

        .input-wrap {
            margin-bottom: 10px;
        }

        .input-wrap input {
            width: 100%;
            max-width: 1000px;
            height: 40px;
            padding: 10px;
        }

        .chatbot-header button {
            background: red;
            color: white;
            border: none;
            font-size: 20px;
            padding: 5px;
            width: 60px;
            border-radius: 10px;
        }

        .settings-sidebar-content select {
            margin-top: 30px;
        }

        .settings-sidebar-content {
            margin-top: 30px;
        }

        .category-link {
            margin-top: 30px;
        }

        .closse-btn {
            background: red;
            color: white;
            border-radius: 10px;
            border: none;
            padding: 10px;
            font-size: 10px;
            width: 100px;
            margin-top: 30px;
            display: flex;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">ALMO</div>
        <div class="header-buttons">
            <button onclick="openSettingsSidebar()" class="menu-btn" title="Menyu">
                <i class="material-icons">menu</i>
            </button>
            <button onclick="showCartModal(); toggleCartButton();" class="cart-btn" title="Savat"> 
                <i class="material-icons">shopping_cart</i>
                <span class="cart-count" id="cartCount">0</span>
            </button>
            <button onclick="toggleChatbot()" class="chatbot-btn" title="AI Yordamchi">
                <i class="material-icons">chat</i>
            </button>
        </div>
    </header>
    <main>
        <div class="search-section">
            <input type="search" id="searchInput" placeholder="Mahsulot Qidiring..." oninput="performSearch()">
            <button class="catalog-btn" onclick="openSidebar()">Katalog</button>
        </div>
        <div id="sidebar" class="sidebar">
            <a href="javascript:void(0)" class="close-btn" onclick="closeSidebar()">×</a>
            <div id="mainCategories" class="category-content active">
                <a href="#" onclick="filterByCategory('Tarix')">Tarix</a>
                <hr>
                <a href="#" onclick="filterByCategory('Barchasi')">Barchasi</a>
                <a href="#" onclick="filterByCategory('Avto Ehtiyot Qismlar')">Avto Ehtiyot Qismlar</a>
                <a href="#" onclick="filterByCategory('Kiyimlar')">Kiyimlar</a>
                <a href="#" onclick="filterByCategory('Elektronika')">Elektronika</a>
            </div>
        </div>
        <div id="settingsSidebar" class="settings-sidebar">
            <a href="javascript:void(0)" class="close-btn" onclick="closeSettingsSidebar()">×</a>
            <div class="settings-sidebar-content">
                <div id="mainSettings" class="category-content active">
                    <p id="userNameDisplay"></p>
                    <div class="category-link" onclick="showProfileSettings()">Profil</div>
                    <div class="category-link" onclick="showLanguageSettings()">Sozlamalar</div>
                    <div class="category-link" onclick="showPlatformColorSettings()">Platformani Ranglari</div>
                </div>
                <div id="profileSettings" class="category-content">
                    <span class="back-arrow" onclick="showMainSettings()">←</span>
                    <h3>Profil</h3>
                    <input type="text" id="profileFirstName" placeholder="Ism" required>
                    <input type="text" id="profileLastName" placeholder="Familiya" required>
                    <input type="tel" id="profilePhoneNumber" placeholder="Telefon raqami (+998)" required>
                    <button class="submit-btn" onclick="sendSMSCode()">SMS Kod Yuborish</button>
                    <input type="text" id="smsCode" placeholder="5 raqamli SMS kod" maxlength="5" style="display: none;">
                    <p id="smsError" class="error-message"></p>
                    <button class="submit-btn" id="verifySMSButton" onclick="verifySMSCode()" style="display: none;">Tasdiqlash</button>
                </div>
                <div id="languageSettings" class="category-content">
                    <span class="back-arrow" onclick="showMainSettings()">←</span>
                    <h3>Sozlamalar</h3>
                    <select id="languageSelect" onchange="updateLang()">
                        <option value="uz">O'zbek</option>
                        <option value="ru">Русский</option>
                    </select>
                </div>
                <div id="platformColorSettings" class="category-content">
                    <span class="back-arrow" onclick="showMainSettings()">←</span>
                    <h3>Platformani Ranglari</h3>
                    <div class="color-options">
                        <label class="color-option">
                            <input type="radio" name="platformColor" value="#4caf50" onchange="changePlatformColor(this.value)">
                            <span style="background-color: #4caf50;"></span> Yashil
                        </label>
                        <label class="color-option">
                            <input type="radio" name="platformColor" value="#007bff" onchange="changePlatformColor(this.value)" checked>
                            <span style="background-color: #007bff;"></span> Ko'k
                        </label>
                        <label class="color-option">
                            <input type="radio" name="platformColor" value="#e91e63" onchange="changePlatformColor(this.value)">
                            <span style="background-color: #e91e63;"></span> Pushti
                        </label>
                        <label class="color-option">    
                            <input type="radio" name="platformColor" value="#ff9800" onchange="changePlatformColor(this.value)">
                            <span style="background-color: #ff9800;"></span> To'q sariq
                        </label>
                    </div>
                    <h3>Header Rangi</h3>
                    <div class="header-color-options">
                        <label class="header-color-option">
                            <input type="radio" name="headerColor" value="#ffffff" onchange="changeHeaderColor(this.value)" checked>
                            <span style="background-color: #ffffff;"></span> Oq
                        </label>
                        <label class="header-color-option">
                            <input type="radio" name="headerColor" value="#f0f0f0" onchange="changeHeaderColor(this.value)">
                            <span style="background-color: #f0f0f0;"></span> Kulrang
                        </label>
                        <label class="header-color-option">
                            <input type="radio" name="headerColor" value="#e0f7fa" onchange="changeHeaderColor(this.value)">
                            <span style="background-color: #e0f7fa;"></span> Moviy
                        </label>
                        <label class="header-color-option">
                            <input type="radio" name="headerColor" value="#ffebee" onchange="changeHeaderColor(this.value)">
                            <span style="background-color: #ffebee;"></span> Pushti
                        </label>
                    </div>
                    <h3>Savatcha Rangi</h3>
                    <div class="cart-color-options">
                        <label class="cart-color-option">
                            <input type="radio" name="cartColor" value="#e0f7fa" onchange="changeCartColor(this.value)" checked>
                            <span style="background-color: #e0f7fa;"></span> Moviy
                        </label>
                        <label class="cart-color-option">
                            <input type="radio" name="cartColor" value="#ffffff" onchange="changeCartColor(this.value)">
                            <span style="background-color: #ffffff;"></span> Oq
                        </label>
                        <label class="cart-color-option">
                            <input type="radio" name="cartColor" value="#f0f0f0" onchange="changeCartColor(this.value)">
                            <span style="background-color: #f0f0f0;"></span> Kulrang
                        </label>
                        <label class="cart-color-option">
                            <input type="radio" name="cartColor" value="#ffebee" onchange="changeCartColor(this.value)">
                            <span style="background-color: #ffebee;"></span> Pushti
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <button id="backButton" class="back-button" onclick="goBackToAllProducts()">Orqaga</button>
        <div id="products" class="products"></div>
        <div class="cart-form" id="cartModal">
            <h3>Savat</h3>
            <div class="cart-items" id="cartItems"></div>
            <p id="totalPrice" style="font-weight: bold; text-align: right;"></p>
            <h4>Mijoz Ma'lumotlari</h4>
            <input type="text" id="firstName" placeholder="Ism" required readonly>
            <input type="text" id="lastName" placeholder="Familiya" required readonly>
            <input type="tel" id="phoneNumber" placeholder="Telefon raqami (+998)" required readonly>
            <div class="input-wrap">
                <input id="address" type="text" placeholder="Tanlangan manzil shu yerga yoziladi" required />
            </div>
            <button type="button" onclick="getCurrentLocation()">Joriy Manzil</button>
            <div id="map"></div>
            <div class="payment-section">
                <label>To'lov usuli</label>
                <div class="payment-options">
                    <label class="payment-option cash">
                        <input type="radio" name="paymentMethod" value="cash" onchange="togglePaymentDetails()">
                        <span>Naqt</span>
                    </label>
                    <label class="payment-option card">
                        <input type="radio" name="paymentMethod" value="card" onchange="togglePaymentDetails()">
                        <span>Karta</span>
                    </label>
                    <label class="payment-option credit">
                        <input type="radio" name="paymentMethod" value="credit" onchange="togglePaymentDetails()">
                        <span>Kredit</span>
                    </label>
                </div>
                <div id="cardDetails" class="payment-details">
                    <input type="text" id="cardNumber" placeholder="Karta raqami (16 raqam)" maxlength="16" required>
                    <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5">
                    <input type="text" id="cardCvv" placeholder="CVV (3 raqam)" maxlength="3" required>
                    <p id="cardError" class="error-message"></p>
                </div>
                <div id="creditDetails" class="payment-details">
                    <input type="text" id="creditFirstName" placeholder="Ism" required>
                    <input type="text" id="creditLastName" placeholder="Familiya" required>
                    <input type="tel" id="creditPhone" placeholder="Telefon raqami (+998)" required>
                    <input type="text" id="passportId" placeholder="Pasport seriyasi yoki ID" required>
                    <input type="number" id="loanDuration" placeholder="Kredit muddati (oy)" min="1" required>
                    <input type="number" id="monthlyIncome" placeholder="Oylik daromad (so'm)" min="0" required>
                    <p id="creditError" class="error-message"></p>
                </div>
            </div>
            <button class="submit-btn" onclick="submitCart()">Tasdiqlash</button>
            <button class="close-btn" onclick="closeCartModal()">Yopish</button>
        </div>
        <div class="receipt-modal" id="receiptModal">
            <h3>Buyurtma Cheki</h3>
            <div id="receiptContent"></div>
            <div class="div">
                <button class="closse-btn" onclick="closeReceiptModal()">Yopish</button>
            </div>
        </div>
        <div class="product-modal" id="productModal">
            <h3>Mahsulot Ma'lumotlari</h3>
            <div class="product-images" id="productImages"></div>
            <div id="productInfo"></div>
            <button class="close-btn" onclick="closeProductModal()">Yopish</button>
        </div>
        <div class="image-modal" id="imageModal">
            <img id="enlargedImage" src="" alt="Enlarged Image">
            <button class="close-btn" onclick="closeImageModal()">Yopish</button>
        </div>
        <div class="chatbot-container" id="chatbotContainer">
            <div class="chatbot-header">
                <h3>ALMO AI</h3>
                <button onclick="toggleChatbot()">−</button>
            </div>
            <div class="chatbot-messages" id="chatBody"></div>
            <div class="chatbot-input">
                <input type="text" id="chatInput" placeholder="Savol kiriting..." onkeypress="if(event.key === 'Enter') sendChatMessage()">
                <button onclick="sendChatMessage()">Yuborish</button>
            </div>
        </div>
    </main>
    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <h2>ALMO</h2>
            </div>
            <div class="footer-links">
                <a href="./biz-haqimizda.html">Biz haqimizda</a>
                <a href="./ishga.html">Ishga Qabul</a>
            </div>
            <div class="footer-contact">
                <p>Telefon: +998 (93) 857-33-11</p>
                <p>Email: SavdoGo@gmail.com</p>
            </div>
        </div>
        <hr>
        <div class="otasi">
            <div class="footerr"><a href="./keleshuvlar.html">ALMO Bilan Kelishuvlar</a></div>
            <div class="footer-copyright">© 2025 ALMO. Barcha huquqlar himoyalangan.</div>
        </div>
    </footer>
<script>
// Mahsulotlar ro'yxati
const products = [
    { id: 1, name: "Smartfon", price: 1500000, category: "Elektronika", images: ["https://via.placeholder.com/150/FF0000", "https://via.placeholder.com/150/FF5555", "https://via.placeholder.com/150/FF9999"], description: "Zamonaviy smartfon, 4G, 128GB xotira.", keywords: ["smartfon", "telefon", "4G", "128GB", "mobil", "uyali"], stock: 10 },
    { id: 2, name: "Limonad", price: 5000, category: "Ichimlik", images: ["https://via.placeholder.com/150/00FF00", "https://via.placeholder.com/150/55FF55", "https://via.placeholder.com/150/99FF99"], description: "Sovuq ichimlik, tabiiy limon ta'mi.", keywords: ["limonad", "ichimlik", "sovuq", "limon", "suv", "gazli"], stock: 100 },
    { id: 3, name: "Olma", price: 3000, category: "Meva", images: ["https://via.placeholder.com/150/0000FF", "https://via.placeholder.com/150/5555FF", "https://via.placeholder.com/150/9999FF"], description: "Yangi olma, organik.", keywords: ["olma", "meva", "yangi", "organik", "yashil olma", "qizil olma"], stock: 200 },
    { id: 4, name: "Televizor OLED", price: 5000000, category: "Elektronika", images: ["https://via.placeholder.com/150/FFFF00", "https://via.placeholder.com/150/FFFF55", "https://via.placeholder.com/150/FFFF99"], description: "4K OLED televizor, 55 inch smart TV.", keywords: ["televizor", "4K", "OLED", "smart TV", "55 inch", "tv", "tele"], stock: 5 },
    { id: 5, name: "Kostyum", price: 250000, category: "Kiyimlar", images: ["https://via.placeholder.com/150/FF00FF", "https://via.placeholder.com/150/FF55FF", "https://via.placeholder.com/150/FF99FF"], description: "Zamonaviy erkaklar kostyumi.", keywords: ["kostyum", "kiyim", "erkaklar", "moda"], stock: 15 },
    { id: 6, name: "Rul", price: 120000, category: "Avto Ehtiyot Qismlar", images: ["https://via.placeholder.com/150/00FFFF", "https://via.placeholder.com/150/55FFFF", "https://via.placeholder.com/150/99FFFF"], description: "Avtomobil uchun rul.", keywords: ["rul", "avto", "ehtiyot qism"], stock: 8 },
    { id: 7, name: "HR Kitob", price: 50000, category: "HR", images: ["https://via.placeholder.com/150/FFA500", "https://via.placeholder.com/150/FFAA55", "https://via.placeholder.com/150/FFAA99"], description: "HR bo'yicha qo'llanma.", keywords: ["hr", "kitob", "o'quv"], stock: 20 },
    { id: 8, name: "Toyota Corolla", price: 30000000, category: "Mashina", images: ["https://via.placeholder.com/150/800080", "https://via.placeholder.com/150/AA00AA", "https://via.placeholder.com/150/CC00CC"], description: "2023-yil Toyota Corolla, 1.6L dvigatel.", keywords: ["mashina", "toyota", "corolla", "avto", "2023"], stock: 2 },
    { id: 9, name: "Dvigatel Yog'i", price: 150000, category: "Avto Ehtiyot Qismlar", images: ["https://via.placeholder.com/150/008080", "https://via.placeholder.com/150/55AAAA", "https://via.placeholder.com/150/99CCCC"], description: "10W-40 dvigatel yog'i, 4 litr.", keywords: ["dvigatel yogi", "avto", "yog'i", "10w40"], stock: 50 },
    { id: 10, name: "Shina 185/65R15", price: 800000, category: "Avto Ehtiyot Qismlar", images: ["https://via.placeholder.com/150/FFA500", "https://via.placeholder.com/150/FFAA55", "https://via.placeholder.com/150/FFAA99"], description: "Yozgi shina, 185/65R15 o'lcham.", keywords: ["shina", "avto", "yozgi", "185/65r15"], stock: 20 }
];

// Fallback javoblar
const fallbackResponses = {
    uz: {
        greeting: "Assalomu Alaykum! SavdoGo platformasida xush kelibsiz. Sizga qanday yordam bera olaman?",
        notFound: "Savolingizni tushunmadim. Iltimos, aniqroq yozing.",
        error: "Texnik xato yuz berdi. Keyinroq urinib ko‘ring.",
        catalog: "Katalogni ko‘rish uchun 'Katalog' tugmasini bosing yoki quyidagi mahsulotlarni ko‘ring:<br>" +
                products.map(p => `${p.name} - ${p.price.toLocaleString('uz-UZ')} so‘m`).join('<br>'),
        help: "Mavjud komandalar: Smartfonlar, Kredit, Naqt, Manzil, Registratsiya, Profil, Katalog, Platforma haqida, To‘lovlar, Narxlar ro‘yxati, Aksiya, Savat holati, Buyurtma holati, Mahsulot tavsifi, Bog‘lanish, Yetkazib berish muddati, Mahsulot qaytarish, Chegirmalar, Mahsulot mavjudligi, To‘lov holati, Shikoyat, Kategoriyalar, Eng arzon, Savatni tozalash, Ishlash uchun bog‘lanish, Promokod, Mahsulot solishtirish, Sayt foydalanish qo‘llanmasi, Buyurtma bekor qilish, Mahsulot sifati, Yordam, Mashinalar."
    },
    ru: {
        greeting: "Здравствуйте! Добро пожаловать на платформу SavdoGo. Чем могу помочь?",
        notFound: "Не понял ваш запрос. Пожалуйста, напишите точнее.",
        error: "Произошла техническая ошибка. Попробуйте позже.",
        catalog: "Для просмотра каталога нажмите кнопку 'Каталог' или ознакомьтесь с товарами:<br>" +
                products.map(p => `${p.name} - ${p.price.toLocaleString('ru-RU')} сум`).join('<br>'),
        help: "Доступные команды: Смартфоны, Кредит, Наличные, Адрес, Регистрация, Профиль, Каталог, О платформе, Оплаты, Список цен, Акция, Состояние корзины, Статус заказа, Описание товара, Контакты, Срок доставки, Возврат товара, Скидки, Наличие товара, Статус оплаты, Жалоба, Категории, Самый дешевый, Очистить корзину, Связь для работы, Промокод, Сравнение товаров, Руководство по сайту, Отмена заказа, Качество товара, Помощь, Автомобили."
    }
};

// O'zgaruvchilar
let cart = JSON.parse(localStorage.getItem('cart')) || [];
let orderHistory = JSON.parse(localStorage.getItem('orderHistory')) || [];
let isChatbotOpen = false;
let greeted = false;
let chatHistory = [];
let map, marker;
let currentCategory = null;
let generatedSMSCode = null;
let userProfile = JSON.parse(localStorage.getItem('userProfile')) || null;
let isCartButtonActive = JSON.parse(localStorage.getItem('cartButtonActive')) || false;

// Toshkent chegaralari
const TASHKENT_BOUNDS = {
    latMin: 40.8,
    latMax: 41.6,
    lonMin: 68.8,
    lonMax: 69.6
};

// DOM elementlari
const productsContainer = document.getElementById('products');
const cartModal = document.getElementById('cartModal');
const settingsSidebar = document.getElementById('settingsSidebar');
const cartItems = document.getElementById('cartItems');
const totalPrice = document.getElementById('totalPrice');
const cartCount = document.getElementById('cartCount');
const chatInput = document.getElementById('chatInput');
const chatBody = document.getElementById('chatBody');
const receiptModal = document.getElementById('receiptModal');
const sidebar = document.getElementById('sidebar');
const backButton = document.getElementById('backButton');
const productModal = document.getElementById('productModal');
const imageModal = document.getElementById('imageModal');
const productImages = document.getElementById('productImages');
const productInfo = document.getElementById('productInfo');
const enlargedImage = document.getElementById('enlargedImage');
const userNameDisplay = document.getElementById('userNameDisplay');
const mainSettings = document.getElementById('mainSettings');
const profileSettings = document.getElementById('profileSettings');
const languageSettings = document.getElementById('languageSettings');
const platformColorSettings = document.getElementById('platformColorSettings');

// Xarita inicializatsiyasi
function initMap() {
    if (map) map.remove();
    map = L.map('map', {
        minZoom: 10,
        maxBounds: [
            [TASHKENT_BOUNDS.latMin, TASHKENT_BOUNDS.lonMin],
            [TASHKENT_BOUNDS.latMax, TASHKENT_BOUNDS.lonMax]
        ],
        maxBoundsViscosity: 1.0
    }).setView([41.3111, 69.2797], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '© OpenStreetMap',
        tileSize: 256,
        zoomOffset: 0
    }).addTo(map);

    window.addEventListener('resize', () => map.invalidateSize());

    map.on('click', async (e) => {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;
        const lang = document.getElementById('languageSelect')?.value || 'uz';

        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lon]).addTo(map);

        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1&lang=${lang}`);
            const data = await res.json();
            const address = data.display_name || (lang === 'uz' ? "Manzil topilmadi" : "Адрес не найден");
            const addressInput = document.getElementById('address');
            if (addressInput) {
                addressInput.value = address;
                if (userProfile) {
                    userProfile.address = address;
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                }
                marker.bindPopup(address).openPopup();
            }
        } catch (error) {
            console.error('Geocoding error:', error);
            alert(lang === 'uz' ? "Manzil topilmadi!" : "Ошибка при определении адреса!");
        }
    });

    setTimeout(() => map.invalidateSize(), 200);
}

// Joriy manzilni olish
function getCurrentLocation() {
    const lang = document.getElementById('languageSelect')?.value || 'uz';
    if (!navigator.geolocation) {
        alert(lang === 'uz' ? 'Brauzeringiz geolokatsiyani qo‘llab-quvvatlamaydi.' : 
            'Ваш браузер не поддерживает геолокацию.');
        return;
    }

    initMap();
    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const inTashkent = lat >= TASHKENT_BOUNDS.latMin && lat <= TASHKENT_BOUNDS.latMax && 
                            lon >= TASHKENT_BOUNDS.lonMin && lon <= TASHKENT_BOUNDS.lonMax;
            if (!inTashkent) {
                alert(lang === 'uz' ? "Joriy manzil Toshkent hududida emas!" : 
                    "Текущий адрес находится за пределами Ташкента!");
                return;
            }

            map.setView([lat, lon], 15);
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lon]).addTo(map);

            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1&lang=${lang}`)
                .then(response => response.json())
                .then(data => {
                    const address = data.display_name || (lang === 'uz' ? 'Manzil aniqlanmadi' : 'Адрес не определен');
                    const addressInput = document.getElementById('address');
                    if (addressInput) {
                        addressInput.value = address;
                        if (userProfile) {
                            userProfile.address = address;
                            localStorage.setItem('userProfile', JSON.stringify(userProfile));
                        }
                        marker.bindPopup(address).openPopup();
                    }
                    setTimeout(() => map.invalidateSize(), 200);
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    alert(lang === 'uz' ? "Manzilni aniqlashda xato yuz berdi!" : 
                        "Ошибка при определения адреса!");
                });
        },
        (error) => {
            let errorMessage;
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = lang === 'uz' ? 'Geolokatsiyaga ruxsat berilmadi. Iltimos, brauzer sozlamalarida ruxsat bering.' : 
                                'Доступ к геолокации запрещен. Пожалуйста, разрешите доступ в настройках браузера.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = lang === 'uz' ? 'Joriy manzilni aniqlash imkonsiz.' : 
                                'Текущий адрес недоступен.';
                    break;
                case error.TIMEOUT:
                    errorMessage = lang === 'uz' ? 'Manzilni aniqlash vaqti tugadi.' : 
                                'Время ожидания определения адреса истекло.';
                    break;
                default:
                    errorMessage = lang === 'uz' ? 'Geolokatsiyada noma’lum xato yuz berdi.' : 
                                'Произошла неизвестная ошибка геолокации.';
            }
            alert(errorMessage + (lang === 'uz' ? ' Iltimos, manzilni xaritada tanlang.' : 
                ' Пожалуйста, выберите адрес на карте.'));
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
}

// Mahsulot modalini ko'rsatish
function showProductModal(productId) {
    const product = products.find(p => p.id === productId);
    if (!product || !productModal) {
        console.error('Product or product modal not found');
        return;
    }
    const lang = document.getElementById('languageSelect')?.value || 'uz';

    productImages.innerHTML = product.images.slice(0, 3).map((img, index) => `
        <img src="${img}" alt="${product.name} ${index + 1}" onclick="showImageModal('${img}')" class="product-image">
    `).join('');

    productInfo.innerHTML = `
        <h3>${product.name}</h3>
        <p><strong>${lang === 'uz' ? 'Narx' : 'Цена'}:</strong> ${product.price.toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m</p>
        <p><strong>${lang === 'uz' ? 'Tavsif' : 'Описание'}:</strong> ${product.description}</p>
        <p><strong>${lang === 'uz' ? 'Omborda' : 'В наличии'}:</strong> ${product.stock} ${lang === 'uz' ? 'dona' : 'шт.'}</p>
        <p><strong>${lang === 'uz' ? 'Qaytarish holati' : 'Статус возврата'}:</strong> ${lang === 'uz' ? '7 kun ichida qaytarish mumkin' : 'Возврат возможен в течение 7 дней'}</p>
    `;

    productModal.classList.add('active');
}

// Rasm modalini ko'rsatish
function showImageModal(imageSrc) {
    if (!imageModal) {
        console.error('Image modal not found');
        return;
    }
    enlargedImage.src = imageSrc;
    imageModal.classList.add('active');
}

// Mahsulot modalini yopish
function closeProductModal() {
    if (!productModal) {
        console.error('Product modal not found');
        return;
    }
    productModal.classList.remove('active');
}

// Rasm modalini yopish
function closeImageModal() {
    if (!imageModal) {
        console.error('Image modal not found');
        return;
    }
    imageModal.classList.remove('active');
}

// Sozlamalar sidebarnini ochish
function openSettingsSidebar() {
    if (!settingsSidebar) {
        console.error('Settings sidebar not found');
        return;
    }
    settingsSidebar.style.width = '300px';
    showMainSettings();
    document.addEventListener('click', settingsOutsideClickListener);
}

// Sozlamalar sidebarnini yopish
function closeSettingsSidebar() {
    if (!settingsSidebar) {
        console.error('Settings sidebar not found');
        return;
    }
    settingsSidebar.style.width = '0';
    document.getElementById('profileFirstName').value = '';
    document.getElementById('profileLastName').value = '';
    document.getElementById('profilePhoneNumber').value = '';
    document.getElementById('smsCode').value = '';
    generatedSMSCode = null;
    document.removeEventListener('click', settingsOutsideClickListener);
}

// Sozlamalar sidebar tashqarisida bosishni aniqlash
function settingsOutsideClickListener(event) {
    if (!settingsSidebar.contains(event.target) && !document.querySelector('.menu-btn').contains(event.target)) {
        closeSettingsSidebar();
    }
}

// Asosiy sozlamalarni ko'rsatish
function showMainSettings() {
    mainSettings.classList.add('active');
    profileSettings.classList.remove('active');
    languageSettings.classList.remove('active');
    platformColorSettings.classList.remove('active');
    const lang = document.getElementById('languageSelect')?.value || 'uz';
    userNameDisplay.textContent = userProfile ? 
        `${userProfile.firstName || ''} ${userProfile.lastName || ''}` : 
        (lang === 'uz' ? 'Foydalanuvchi' : 'Пользователь');
}

// Profil sozlamalarini ko'rsatish
function showProfileSettings() {
    mainSettings.classList.remove('active');
    profileSettings.classList.add('active');
    languageSettings.classList.remove('active');
    platformColorSettings.classList.remove('active');
    document.getElementById('smsCode').style.display = 'none';
    document.getElementById('verifySMSButton').style.display = 'none';
    document.getElementById('smsError').style.display = 'none';
    if (userProfile) {
        document.getElementById('profileFirstName').value = userProfile.firstName || '';
        document.getElementById('profileLastName').value = userProfile.lastName || '';
        document.getElementById('profilePhoneNumber').value = userProfile.phoneNumber || '';
    }
}

// Til sozlamalarini ko'rsatish
function showLanguageSettings() {
    mainSettings.classList.remove('active');
    profileSettings.classList.remove('active');
    languageSettings.classList.add('active');
    platformColorSettings.classList.remove('active');
}

// Platforma ranglarini sozlash
function showPlatformColorSettings() {
    mainSettings.classList.remove('active');
    profileSettings.classList.remove('active');
    languageSettings.classList.remove('active');
    platformColorSettings.classList.add('active');
    
    const savedPlatformColor = localStorage.getItem('platformColor') || '#ffffff'; // Oq rang dastlabki
    document.querySelector(`input[name="platformColor"][value="${savedPlatformColor}"]`).checked = true;
    changePlatformColor(savedPlatformColor);

    const savedMainBgColor = localStorage.getItem('mainBgColor') || '#f5f5f5'; // Asosiy fon uchun default
    document.querySelector(`input[name="mainBgColor"][value="${savedMainBgColor}"]`).checked = true;
    changeMainBgColor(savedMainBgColor);

    const savedCartColor = localStorage.getItem('cartColor') || '#e0f7fa'; // Savatcha uchun default
    document.querySelector(`input[name="cartColor"][value="${savedCartColor}"]`).checked = true;
    changeCartColor(savedCartColor);
}

// Platforma rangini o'zgartirish (tugmalar va boshqa elementlar)
function changePlatformColor(color) {
    localStorage.setItem('platformColor', color);
    const hoverColor = darkenColor(color, 0.1);
    document.documentElement.style.setProperty('--platform-bg', color);
    document.documentElement.style.setProperty('--button-color', color);
    document.documentElement.style.setProperty('--button-hover-color', hoverColor);
    document.querySelectorAll('.product button.add-to-cart').forEach(button => {
        button.style.background = color;
    });
    document.querySelectorAll('.quantity-selector button').forEach(button => {
        button.style.background = color;
    });
    document.querySelectorAll('.cart-form .submit-btn').forEach(button => {
        button.style.background = color;
    });
    document.querySelectorAll('.settings-sidebar-content .submit-btn').forEach(button => {
        button.style.background = color;
    });
    document.querySelector('.catalog-btn').style.background = color;
    document.querySelector('#creditNextBtn').style.background = color;
    document.querySelector('.chatbot-header').style.background = color;
    document.querySelector('.chatbot-input button').style.background = color;
    document.querySelector('.back-button').style.background = color;
}

// Asosiy fon rangini o'zgartirish
function changeMainBgColor(color) {
    localStorage.setItem('mainBgColor', color);
    document.documentElement.style.setProperty('--main-bg', color);
}

// Savatcha rangini o'zgartirish
function changeCartColor(color) {
    localStorage.setItem('cartColor', color);
    const hoverColor = darkenColor(color, 0.1);
    document.documentElement.style.setProperty('--cart-button-bg', color);
    document.documentElement.style.setProperty('--cart-button-hover-bg', hoverColor);
    document.querySelector('.cart-btn').style.background = color;
}

// Savatcha tugmasini faollashtirish/yopish
function toggleCartButton() {
    const cartButton = document.querySelector('.cart-btn');
    isCartButtonActive = !isCartButtonActive;
    cartButton.classList.toggle('active', isCartButtonActive);
    localStorage.setItem('cartButtonActive', isCartButtonActive);
}

// Rangni qorong'ilashtirish
function darkenColor(hex, amount) {
    hex = hex.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    const darkerR = Math.max(0, Math.floor(r * (1 - amount)));
    const darkerG = Math.max(0, Math.floor(g * (1 - amount)));
    const darkerB = Math.max(0, Math.floor(b * (1 - amount)));
    return `#${darkerR.toString(16).padStart(2, '0')}${darkerG.toString(16).padStart(2, '0')}${darkerB.toString(16).padStart(2, '0')}`;
}

// SMS kod yuborish
function sendSMSCode() {
    const firstName = document.getElementById('profileFirstName').value.trim();
    const lastName = document.getElementById('profileLastName').value.trim();
    const phoneNumber = document.getElementById('profilePhoneNumber').value.trim();
    const smsError = document.getElementById('smsError');
    const lang = document.getElementById('languageSelect')?.value || 'uz';

    if (!firstName || !lastName || !phoneNumber) {
        smsError.textContent = lang === 'uz' ? 'Iltimos, barcha maydonlarni to‘ldiring.' : 
                            'Пожалуйста, заполните все поля.';
        smsError.style.display = 'block';
        return;
    }
    if (!/^\+998\d{9}$/.test(phoneNumber)) {
        smsError.textContent = lang === 'uz' ? 'Telefon raqami +998 bilan boshlanishi va 9 raqamdan iborat bo‘lishi kerak.' : 
                            'Номер телефона должен начинаться с +998 и содержать 9 цифр.';
        smsError.style.display = 'block';
        return;
    }

    generatedSMSCode = Math.floor(10000 + Math.random() * 90000).toString();
    alert(`${lang === 'uz' ? 'SMS kod yuborildi: ' : 'SMS-код отправлен: '}${generatedSMSCode}`);
    document.getElementById('smsCode').style.display = 'block';
    document.getElementById('verifySMSButton').style.display = 'block';
    smsError.style.display = 'none';
}

// SMS kodni tasdiqlash
function verifySMSCode() {
    const smsCode = document.getElementById('smsCode').value.trim();
    const smsError = document.getElementById('smsError');
    const lang = document.getElementById('languageSelect')?.value || 'uz';

    if (!/^\d{5}$/.test(smsCode)) {
        smsError.textContent = lang === 'uz' ? 'SMS kod 5 raqamdan iborat bo‘lishi kerak.' : 
                            'SMS-код должен состоять из 5 цифр.';
        smsError.style.display = 'block';
        return;
    }
    if (smsCode !== generatedSMSCode) {
        smsError.textContent = lang === 'uz' ? 'Noto‘g‘ri SMS kod.' : 'Неверный SMS-код.';
        smsError.style.display = 'block';
        return;
    }

    userProfile = {
        firstName: document.getElementById('profileFirstName').value.trim(),
        lastName: document.getElementById('profileLastName').value.trim(),
        phoneNumber: document.getElementById('profilePhoneNumber').value.trim(),
        address: userProfile?.address || ''
    };
    localStorage.setItem('userProfile', JSON.stringify(userProfile));
    smsError.style.display = 'none';
    alert(lang === 'uz' ? 'Profil muvaffaqiyatli tasdiqlandi!' : 'Профиль успешно подтвержден!');
    showMainSettings();
    updateCart();
}

// Tilni yangilash
function updateLang() {
    const lang = document.getElementById('languageSelect').value;
    const elements = {
        logo: ['ALMO', 'ALMO'],
        searchPlaceholder: ['Mahsulot Qidiring...', 'Поиск товаров...'],
        catalogBtn: ['Katalog', 'Каталог'],
        cartBtn: ['Savat', 'Корзина'],
        menuBtn: ['Menyu', 'Меню'],
        chatbotBtn: ['AI Yordamchi', 'AI Помощник'],
        cartModalTitle: ['Savat', 'Корзина'],
        cartSubmitBtn: ['Tasdiqlash', 'Подтвердить'],
        cartCloseBtn: ['Yopish', 'Закрыть'],
        customerInfoTitle: ['Mijoz Ma\'lumotlari', 'Данные клиента'],
        firstNamePlaceholder: ['Ism', 'Имя'],
        lastNamePlaceholder: ['Familiya', 'Фамилия'],
        phonePlaceholder: ['Telefon raqami (+998)', 'Номер телефона (+998)'],
        addressPlaceholder: ['Tanlangan manzil shu yerga yoziladi', 'Выбранный адрес будет отображён здесь'],
        locationBtn: ['Joriy Manzil', 'Текущее местоположение'],
        paymentLabel: ['To\'lov usuli', 'Способ оплаты'],
        cashOption: ['Naqt', 'Наличные'],
        cardOption: ['Karta', 'Карта'],
        creditOption: ['Kredit', 'Кредит'],
        cardNumberPlaceholder: ['Karta raqami (16 raqam)', 'Номер карты (16 цифр)'],
        cardExpiryPlaceholder: ['MM/YY', 'MM/YY'],
        cardCvvPlaceholder: ['CVV (3 raqam)', 'CVV (3 цифры)'],
        creditFirstNamePlaceholder: ['Ism', 'Имя'],
        creditLastNamePlaceholder: ['Familiya', 'Фамилия'],
        creditPhonePlaceholder: ['Telefon raqami (+998)', 'Номер телефона (+998)'],
        passportIdPlaceholder: ['Pasport seriyasi yoki ID', 'Серия паспорта или ID'],
        loanDurationPlaceholder: ['Kredit muddati (oy)', 'Срок кредита (месяцы)'],
        monthlyIncomePlaceholder: ['Oylik daromad (so\'m)', 'Месячный доход (сум)'],
        receiptModalTitle: ['Buyurtma Cheki', 'Чек заказа'],
        receiptCloseBtn: ['Yopish', 'Закрыть'],
        productModalTitle: ['Mahsulot Ma\'lumotlari', 'Информация о товаре'],
        productCloseBtn: ['Yopish', 'Закрыть'],
        imageModalCloseBtn: ['Yopish', 'Закрыть'],
        chatbotHeader: ['ALMO AI', 'ALMO AI'],
        chatbotPlaceholder: ['Savol kiriting...', 'Введите вопрос...'],
        chatbotSendBtn: ['Yuborish', 'Отправить'],
        profileFirstNamePlaceholder: ['Ism', 'Имя'],
        profileLastNamePlaceholder: ['Familiya', 'Фамилия'],
        profilePhonePlaceholder: ['Telefon raqami (+998)', 'Номер телефона (+998)'],
        smsCodePlaceholder: ['5 raqamli SMS kod', '5-значный SMS-код'],
        sendSMSBtn: ['SMS Kod Yuborish', 'Отправить SMS-код'],
        verifySMSBtn: ['Tasdiqlash', 'Подтвердить'],
        backButton: ['Orqaga', 'Назад'],
        profileSettingsTitle: ['Profil', 'Профиль'],
        languageSettingsTitle: ['Sozlamalar', 'Настройки'],
        colorSettingsTitle: ['Platformani Ranglari', 'Цвета платформы']
    };

    document.querySelector('.logo').textContent = elements.logo[lang === 'uz' ? 0 : 1];
    document.getElementById('searchInput').placeholder = elements.searchPlaceholder[lang === 'uz' ? 0 : 1];
    document.querySelector('.catalog-btn').textContent = elements.catalogBtn[lang === 'uz' ? 0 : 1];
    document.querySelector('.cart-btn').title = elements.cartBtn[lang === 'uz' ? 0 : 1];
    document.querySelector('.menu-btn').title = elements.menuBtn[lang === 'uz' ? 0 : 1];
    document.querySelector('.chatbot-btn').title = elements.chatbotBtn[lang === 'uz' ? 0 : 1];
    document.querySelector('#cartModal h3').textContent = elements.cartModalTitle[lang === 'uz' ? 0 : 1];
    document.querySelector('#cartModal .submit-btn').textContent = elements.cartSubmitBtn[lang === 'uz' ? 0 : 1];
    document.querySelector('#cartModal .close-btn').textContent = elements.cartCloseBtn[lang === 'uz' ? 0 : 1];
    document.querySelector('#cartModal h4').textContent = elements.customerInfoTitle[lang === 'uz' ? 0 : 1];
    document.getElementById('firstName').placeholder = elements.firstNamePlaceholder[lang === 'uz' ? 0 : 1];
    document.getElementById('lastName').placeholder = elements.lastNamePlaceholder[lang === 'uz' ? 0 : 1];
    document.getElementById('phoneNumber').placeholder = elements.phonePlaceholder[lang === 'uz' ? 0 : 1];
    document.getElementById('address').placeholder = elements.addressPlaceholder[lang === 'uz' ? 0 : 1];
    document.querySelector('#cartModal button[onclick="getCurrentLocation()"]').textContent = elements.locationBtn[lang === 'uz' ? 0 : 1];
    document.querySelector('#cartModal .payment-section label').textContent = elements.paymentLabel[lang === 'uz' ? 0 : 1];
    document.querySelector('.payment-option.cash span').textContent = elements.cashOption[lang === 'uz' ? 0 : 1];
    document.querySelector('.payment-option.card span').textContent = elements.cardOption[lang === 'uz' ? 0 : 1];
    document.querySelector('.payment-option.credit span').textContent = elements.creditOption[lang === 'uz' ? 0 : 1];
    document.getElementById('cardNumber').placeholder = elements.cardNumberPlaceholder[lang === 'uz' ? 0 : 1];
    document.getElementById('cardExpiry').placeholder = elements.cardExpiryPlaceholder[lang === 'uz' ? 0 : 1];
    document.getElementById('cardCvv').placeholder = elements.cardCvvPlaceholder[lang === 'uz' ? 0 : 1];
    document.getElementById('creditFirstName').placeholder = elements.creditFirstNamePlaceholder[lang === 'uz' ? 0 : 1];
    document.getElementById('creditLastName').placeholder = elements.creditLastNamePlaceholder[lang === 'uz' ? 0 : 1];
    document.getElementById('creditPhone').placeholder = elements.creditPhonePlaceholder[lang === 'uz' ? 0 : 1];
    document.getElementById('passportId').placeholder = elements.passportIdPlaceholder[lang === 'uz' ? 0 : 1];
    document.getElementById('loanDuration').placeholder = elements.loanDurationPlaceholder[lang === 'uz' ? 0 : 1];
    document.getElementById('monthlyIncome').placeholder = elements.monthlyIncomePlaceholder[lang === 'uz' ? 0 : 1];
    document.querySelector('#receiptModal h3').textContent = elements.receiptModalTitle[lang === 'uz' ? 0 : 1];
    document.querySelector('#receiptModal .closse-btn').textContent = elements.receiptCloseBtn[lang === 'uz' ? 0 : 1];
    document.querySelector('#productModal h3').textContent = elements.productModalTitle[lang === 'uz' ? 0 : 1];
    document.querySelector('#productModal .close-btn').textContent = elements.productCloseBtn[lang === 'uz' ? 0 : 1];
    document.querySelector('#imageModal .close-btn').textContent = elements.imageModalCloseBtn[lang === 'uz' ? 0 : 1];
    document.querySelector('.chatbot-header h3').textContent = elements.chatbotHeader[lang === 'uz' ? 0 : 1];
    document.getElementById('chatInput').placeholder = elements.chatbotPlaceholder[lang === 'uz' ? 0 : 1];
    document.querySelector('.chatbot-input button').textContent = elements.chatbotSendBtn[lang === 'uz' ? 0 : 1];
    document.getElementById('profileFirstName').placeholder = elements.profileFirstNamePlaceholder[lang === 'uz' ? 0 : 1];
    document.getElementById('profileLastName').placeholder = elements.profileLastNamePlaceholder[lang === 'uz' ? 0 : 1];
    document.getElementById('profilePhoneNumber').placeholder = elements.profilePhonePlaceholder[lang === 'uz' ? 0 : 1];
    document.getElementById('smsCode').placeholder = elements.smsCodePlaceholder[lang === 'uz' ? 0 : 1];
    document.querySelector('#profileSettings .submit-btn').textContent = elements.sendSMSBtn[lang === 'uz' ? 0 : 1];
    document.getElementById('verifySMSButton').textContent = elements.verifySMSBtn[lang === 'uz' ? 0 : 1];
    document.getElementById('backButton').textContent = elements.backButton[lang === 'uz' ? 0 : 1];
    document.querySelector('#profileSettings h3').textContent = elements.profileSettingsTitle[lang === 'uz' ? 0 : 1];
    document.querySelector('#languageSettings h3').textContent = elements.languageSettingsTitle[lang === 'uz' ? 0 : 1];
    document.querySelector('#platformColorSettings h3').textContent = elements.colorSettingsTitle[lang === 'uz' ? 0 : 1];

    displayProducts();
    updateCart();
    updateChatbotMessages();
}

// Mahsulotlarni ko'rsatish
function displayProducts(filter = null) {
    const lang = document.getElementById('languageSelect')?.value || 'uz';
    let filteredProducts = products;

    if (filter && filter !== 'Barchasi') {
        filteredProducts = products.filter(p => p.category === filter);
    }

    productsContainer.innerHTML = filteredProducts.map(product => {
        const cartItem = cart.find(item => item.id === product.id);
        const quantity = cartItem ? cartItem.quantity : 0;
        const isInCart = quantity > 0;

        return `
            <div class="product" onclick="showProductModal(${product.id})">
                <img src="${product.images[0]}" alt="${product.name}">
                <h4>${product.name}</h4>
                <p>${product.price.toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m</p>
                <button class="add-to-cart" onclick="addToCart(${product.id}); event.stopPropagation();">${lang === 'uz' ? 'Savatga qo‘shish' : 'Добавить в корзину'}</button>
                <div class="quantity-selector ${isInCart ? 'active' : ''}" id="quantitySelector${product.id}">
                    <button onclick="decreaseQuantity(${product.id}); event.stopPropagation();">-</button>
                    <span id="quantity${product.id}">${quantity}</span>
                    <button onclick="increaseQuantity(${product.id}); event.stopPropagation();">+</button>
                </div>
            </div>
        `;
    }).join('');
}

// Savatga qo'shish
function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;

    const cartItem = cart.find(item => item.id === productId);
    const lang = document.getElementById('languageSelect')?.value || 'uz';

    if (!cartItem) {
        if (product.stock > 0) {
            cart.push({ id: productId, quantity: 1 });
            product.stock -= 1;
        } else {
            alert(lang === 'uz' ? 'Mahsulot omborda mavjud emas!' : 'Товар отсутствует на складе!');
            return;
        }
    } else {
        if (cartItem.quantity < product.stock) {
            cartItem.quantity += 1;
            product.stock -= 1;
        } else {
            alert(lang === 'uz' ? 'Omborda yetarli mahsulot mavjud emas!' : 'На складе недостаточно товара!');
            return;
        }
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCart();
    displayProducts(currentCategory);
}

// Miqdorni kamaytirish
function decreaseQuantity(productId) {
    const cartItem = cart.find(item => item.id === productId);
    const product = products.find(p => p.id === productId);
    if (!cartItem || !product) return;

    cartItem.quantity -= 1;
    product.stock += 1;

    if (cartItem.quantity <= 0) {
        cart = cart.filter(item => item.id !== productId);
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCart();
    displayProducts(currentCategory);
}

// Miqdorni oshirish
function increaseQuantity(productId) {
    const cartItem = cart.find(item => item.id === productId);
    const product = products.find(p => p.id === productId);
    const lang = document.getElementById('languageSelect')?.value || 'uz';

    if (!cartItem || !product) return;

    if (cartItem.quantity < product.stock) {
        cartItem.quantity += 1;
        product.stock -= 1;
    } else {
        alert(lang === 'uz' ? 'Omborda yetarli mahsulot mavjud emas!' : 'На складе недостаточно товара!');
        return;
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCart();
    displayProducts(currentCategory);
}

// Savatni yangilash
function updateCart() {
    const lang = document.getElementById('languageSelect')?.value || 'uz';
    let total = 0;
    cartItems.innerHTML = cart.map(item => {
        const product = products.find(p => p.id === item.id);
        if (!product) return '';
        const itemTotal = product.price * item.quantity;
        total += itemTotal;
        return `
            <div class="cart-item">
                <span>${product.name} (${item.quantity} ${lang === 'uz' ? 'dona' : 'шт.'})</span>
                <span>${itemTotal.toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m</span>
            </div>
        `;
    }).join('');

    totalPrice.textContent = `${lang === 'uz' ? 'Jami' : 'Итого'}: ${total.toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m`;
    cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);

    if (userProfile) {
        document.getElementById('firstName').value = userProfile.firstName || '';
        document.getElementById('lastName').value = userProfile.lastName || '';
        document.getElementById('phoneNumber').value = userProfile.phoneNumber || '';
        document.getElementById('address').value = userProfile.address || '';
    }
}

// Savat modalini ko'rsatish
function showCartModal() {
    if (!userProfile) {
        const lang = document.getElementById('languageSelect')?.value || 'uz';
        alert(lang === 'uz' ? 'Iltimos, avval profilni to‘ldiring.' : 'Пожалуйста, сначала заполните профиль.');
        openSettingsSidebar();
        showProfileSettings();
        return;
    }

    initMap();
    cartModal.classList.add('active');
    updateCart();
}

// Savat modalini yopish
function closeCartModal() {
    cartModal.classList.remove('active');
    document.querySelectorAll('.payment-details').forEach(detail => detail.classList.remove('active'));
}

// To'lov tafsilotlarini ko'rsatish/yashirish
function togglePaymentDetails() {
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
    document.getElementById('cardDetails').classList.toggle('active', paymentMethod === 'card');
    document.getElementById('creditDetails').classList.toggle('active', paymentMethod === 'credit');
}

// Savatni tasdiqlash
function submitCart() {
    const lang = document.getElementById('languageSelect')?.value || 'uz';
    if (cart.length === 0) {
        alert(lang === 'uz' ? 'Savat bo‘sh!' : 'Корзина пуста!');
        return;
    }

    if (!userProfile) {
        alert(lang === 'uz' ? 'Iltimos, avval profilni to‘ldiring.' : 'Пожалуйста, сначала заполните профиль.');
        openSettingsSidebar();
        showProfileSettings();
        return;
    }

    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const phoneNumber = document.getElementById('phoneNumber').value.trim();
    const address = document.getElementById('address').value.trim();
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;

    if (!firstName || !lastName || !phoneNumber || !address || !paymentMethod) {
        alert(lang === 'uz' ? 'Iltimos, barcha maydonlarni to‘ldiring.' : 'Пожалуйста, заполните все поля.');
        return;
    }

    if (paymentMethod === 'card') {
        const cardNumber = document.getElementById('cardNumber').value.trim();
        const cardExpiry = document.getElementById('cardExpiry').value.trim();
        const cardCvv = document.getElementById('cardCvv').value.trim();
        const cardError = document.getElementById('cardError');

        if (!/^\d{16}$/.test(cardNumber)) {
            cardError.textContent = lang === 'uz' ? 'Karta raqami 16 raqamdan iborat bo‘lishi kerak.' : 
                                'Номер карты должен состоять из 16 цифр.';
            cardError.style.display = 'block';
            return;
        }
        if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
            cardError.textContent = lang === 'uz' ? 'Karta amal qilish muddati MM/YY formatida bo‘lishi kerak.' : 
                                'Срок действия карты должен быть в формате MM/YY.';
            cardError.style.display = 'block';
            return;
        }
        if (!/^\d{3}$/.test(cardCvv)) {
            cardError.textContent = lang === 'uz' ? 'CVV 3 raqamdan iborat bo‘lishi kerak.' : 
                                'CVV должен состоять из 3 цифр.';
            cardError.style.display = 'block';
            return;
        }
        cardError.style.display = 'none';
    }

    if (paymentMethod === 'credit') {
        const creditFirstName = document.getElementById('creditFirstName').value.trim();
        const creditLastName = document.getElementById('creditLastName').value.trim();
        const creditPhone = document.getElementById('creditPhone').value.trim();
        const passportId = document.getElementById('passportId').value.trim();
        const loanDuration = document.getElementById('loanDuration').value.trim();
        const monthlyIncome = document.getElementById('monthlyIncome').value.trim();
        const creditError = document.getElementById('creditError');

        if (!creditFirstName || !creditLastName || !creditPhone || !passportId || !loanDuration || !monthlyIncome) {
            creditError.textContent = lang === 'uz' ? 'Iltimos, barcha maydonlarni to‘ldiring.' : 
                                    'Пожалуйста, заполните все поля.';
            creditError.style.display = 'block';
            return;
        }
        if (!/^\+998\d{9}$/.test(creditPhone)) {
            creditError.textContent = lang === 'uz' ? 'Telefon raqami +998 bilan boshlanishi va 9 raqamdan iborat bo‘lishi kerak.' : 
                                    'Номер телефона должен начинаться с +998 и содержать 9 цифр.';
            creditError.style.display = 'block';
            return;
        }
        if (parseInt(loanDuration) < 1) {
            creditError.textContent = lang === 'uz' ? 'Kredit muddati kamida 1 oy bo‘lishi kerak.' : 
                                    'Срок кредита должен быть не менее 1 месяца.';
            creditError.style.display = 'block';
            return;
        }
        if (parseInt(monthlyIncome) < 0) {
            creditError.textContent = lang === 'uz' ? 'Oylik daromad manfiy bo‘lishi mumkin emas.' : 
                                    'Месячный доход не может быть отрицательным.';
            creditError.style.display = 'block';
            return;
        }
        creditError.style.display = 'none';
    }

    const order = {
        id: Date.now(),
        items: cart.map(item => ({
            id: item.id,
            name: products.find(p => p.id === item.id)?.name,
            quantity: item.quantity,
            price: products.find(p => p.id === item.id)?.price
        })),
        total: cart.reduce((sum, item) => sum + (products.find(p => p.id === item.id)?.price * item.quantity), 0),
        customer: { firstName, lastName, phoneNumber, address },
        paymentMethod,
        status: 'pending',
        date: new Date().toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')
    };

    orderHistory.push(order);
    localStorage.setItem('orderHistory', JSON.stringify(orderHistory));
    cart = [];
    localStorage.setItem('cart', JSON.stringify(cart));

    const receiptContent = `
        <p><strong>${lang === 'uz' ? 'Buyurtma ID' : 'ID заказа'}:</strong> ${order.id}</p>
        <p><strong>${lang === 'uz' ? 'Mijoz' : 'Клиент'}:</strong> ${firstName} ${lastName}</p>
        <p><strong>${lang === 'uz' ? 'Telefon' : 'Телефон'}:</strong> ${phoneNumber}</p>
        <p><strong>${lang === 'uz' ? 'Manzil' : 'Адрес'}:</strong> ${address}</p>
        <p><strong>${lang === 'uz' ? 'To‘lov usuli' : 'Способ оплаты'}:</strong> ${paymentMethod === 'cash' ? (lang === 'uz' ? 'Naqt' : 'Наличные') : paymentMethod === 'card' ? (lang === 'uz' ? 'Karta' : 'Карта') : (lang === 'uz' ? 'Kredit' : 'Кредит')}</p>
        <p><strong>${lang === 'uz' ? 'Mahsulotlar' : 'Товары'}:</strong></p>
        ${order.items.map(item => `<p>${item.name} (${item.quantity} ${lang === 'uz' ? 'dona' : 'шт.'}) - ${(item.price * item.quantity).toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m</p>`).join('')}
        <p><strong>${lang === 'uz' ? 'Jami' : 'Итого'}:</strong> ${order.total.toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m</p>
        <p><strong>${lang === 'uz' ? 'Sana' : 'Дата'}:</strong> ${order.date}</p>
    `;
    document.getElementById('receiptContent').innerHTML = receiptContent;
    receiptModal.classList.add('active');
    closeCartModal();
    updateCart();
    displayProducts(currentCategory);
}

// Chek modalini yopish
function closeReceiptModal() {
    receiptModal.classList.remove('active');
}

// Katalog sidebarnini ochish
function openSidebar() {
    sidebar.style.width = '250px';
    document.getElementById('mainCategories').classList.add('active');
    document.addEventListener('click', outsideClickListener);
}

// Katalog sidebarnini yopish
function closeSidebar() {
    sidebar.style.width = '0';
    document.getElementById('mainCategories').classList.add('active');
    document.removeEventListener('click', outsideClickListener);
}

// Sidebar tashqarisida bosishni aniqlash
function outsideClickListener(event) {
    if (!sidebar.contains(event.target) && !document.querySelector('.catalog-btn').contains(event.target)) {
        closeSidebar();
    }
}

// Kategoriya bo'yicha filtrlash
function filterByCategory(category) {
    currentCategory = category;
    backButton.classList.toggle('active', category !== 'Barchasi');
    displayProducts(category);
    closeSidebar();
}

// Barcha mahsulotlarga qaytish
function goBackToAllProducts() {
    currentCategory = 'Barchasi';
    backButton.classList.remove('active');
    displayProducts('Barchasi');
}

// Qidiruv funksiyasi
function performSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    const lang = document.getElementById('languageSelect')?.value || 'uz';
    let filteredProducts = products;

    if (searchTerm) {
        filteredProducts = products.filter(product => 
            product.name.toLowerCase().includes(searchTerm) ||
            product.description.toLowerCase().includes(searchTerm) ||
            product.keywords.some(keyword => keyword.toLowerCase().includes(searchTerm))
        );
    }

    productsContainer.innerHTML = filteredProducts.length > 0 ? filteredProducts.map(product => {
        const cartItem = cart.find(item => item.id === product.id);
        const quantity = cartItem ? cartItem.quantity : 0;
        const isInCart = quantity > 0;

        return `
            <div class="product" onclick="showProductModal(${product.id})">
                <img src="${product.images[0]}" alt="${product.name}">
                <h4>${product.name}</h4>
                <p>${product.price.toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m</p>
                <button class="add-to-cart" onclick="addToCart(${product.id}); event.stopPropagation();">${lang === 'uz' ? 'Savatga qo‘shish' : 'Добавить в корзину'}</button>
                <div class="quantity-selector ${isInCart ? 'active' : ''}" id="quantitySelector${product.id}">
                    <button onclick="decreaseQuantity(${product.id}); event.stopPropagation();">-</button>
                    <span id="quantity${product.id}">${quantity}</span>
                    <button onclick="increaseQuantity(${product.id}); event.stopPropagation();">+</button>
                </div>
            </div>
        `;
    }).join('') : `<p>${lang === 'uz' ? 'Mahsulot topilmadi!' : 'Товары не найдены!'}</p>`;
}

// Chatbotni ochish/yopish
function toggleChatbot() {
    const chatbotContainer = document.getElementById('chatbotContainer');
    isChatbotOpen = !isChatbotOpen;
    chatbotContainer.classList.toggle('active', isChatbotOpen);
    if (isChatbotOpen && !greeted) {
        addChatbotMessage(fallbackResponses[document.getElementById('languageSelect')?.value || 'uz'].greeting, 'bot');
        greeted = true;
    }
}

// Chatbot xabarlarini yangilash
function updateChatbotMessages() {
    const lang = document.getElementById('languageSelect')?.value || 'uz';
    chatBody.innerHTML = chatHistory.map(msg => `
        <div class="chatbot-message ${msg.type}">
            ${msg.text}
            ${msg.image ? `<img src="${msg.image}" alt="chatbot-image">` : ''}
        </div>
    `).join('');
    chatBody.scrollTop = chatBody.scrollHeight;
}

// Chatbot xabarini yuborish
function sendChatMessage() {
    const message = chatInput.value.trim();
    const lang = document.getElementById('languageSelect')?.value || 'uz';
    if (!message) return;

    addChatbotMessage(message, 'user');
    chatInput.value = '';

    const lowerMessage = message.toLowerCase();
    let response = '';

    if (lowerMessage.includes('salom') || lowerMessage.includes('здравствуйте')) {
        response = fallbackResponses[lang].greeting;
    } else if (lowerMessage.includes('katalog') || lowerMessage.includes('каталог')) {
        response = fallbackResponses[lang].catalog;
    } else if (lowerMessage.includes('yordam') || lowerMessage.includes('помощь')) {
        response = fallbackResponses[lang].help;
    } else if (lowerMessage.includes('savat holati') || lowerMessage.includes('состояние корзины')) {
        if (cart.length === 0) {
            response = lang === 'uz' ? 'Savat bo‘sh!' : 'Корзина пуста!';
        } else {
            response = cart.map(item => {
                const product = products.find(p => p.id === item.id);
                return `${product.name} (${item.quantity} ${lang === 'uz' ? 'dona' : 'шт.'}) - ${(product.price * item.quantity).toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m`;
            }).join('<br>') + `<br><strong>${lang === 'uz' ? 'Jami' : 'Итого'}:</strong> ${cart.reduce((sum, item) => sum + (products.find(p => p.id === item.id)?.price * item.quantity), 0).toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m`;
        }
    } else if (lowerMessage.includes('buyurtma holati') || lowerMessage.includes('статус заказа')) {
        if (orderHistory.length === 0) {
            response = lang === 'uz' ? 'Hozirda buyurtmalar yo‘q.' : 'На данный момент заказов нет.';
        } else {
            response = orderHistory.map(order => `
                <p><strong>${lang === 'uz' ? 'Buyurtma ID' : 'ID заказа'}:</strong> ${order.id}</p>
                <p><strong>${lang === 'uz' ? 'Sana' : 'Дата'}:</strong> ${order.date}</p>
                <p><strong>${lang === 'uz' ? 'Holati' : 'Статус'}:</strong> ${order.status === 'pending' ? (lang === 'uz' ? 'Kutilmoqda' : 'Ожидает') : (lang === 'uz' ? 'Bajarildi' : 'Выполнен')}</p>
            `).join('<br>');
        }
    } else if (lowerMessage.includes('mahsulot tavsifi') || lowerMessage.includes('описание товара')) {
        const productName = lowerMessage.replace(/(mahsulot tavsifi|описание товара)/i, '').trim();
        const product = products.find(p => p.name.toLowerCase().includes(productName));
        if (product) {
            response = `
                <strong>${product.name}</strong><br>
                ${lang === 'uz' ? 'Tavsif' : 'Описание'}: ${product.description}<br>
                ${lang === 'uz' ? 'Narx' : 'Цена'}: ${product.price.toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m<br>
                ${lang === 'uz' ? 'Omborda' : 'В наличии'}: ${product.stock} ${lang === 'uz' ? 'dona' : 'шт.'}
            `;
        } else {
            response = lang === 'uz' ? 'Mahsulot topilmadi!' : 'Товар не найден!';
        }
    } else if (lowerMessage.includes('bog‘lanish') || lowerMessage.includes('контакты')) {
        response = lang === 'uz' ? 'Telefon: +998 (93) 857-33-11<br>Email: SavdoGo@gmail.com' : 
                                'Телефон: +998 (93) 857-33-11<br>Email: SavdoGo@gmail.com';
    } else if (lowerMessage.includes('yetkazib berish muddati') || lowerMessage.includes('срок доставки')) {
        response = lang === 'uz' ? 'Yetkazib berish muddati 1-3 ish kuni ichida.' : 
                                'Срок доставки составляет 1-3 рабочих дня.';
    } else if (lowerMessage.includes('mahsulot qaytarish') || lowerMessage.includes('возврат товара')) {
        response = lang === 'uz' ? 'Mahsulotni 7 kun ichida qaytarish mumkin.' : 
                                'Товар можно вернуть в течение 7 дней.';
    } else if (lowerMessage.includes('chegirmalar') || lowerMessage.includes('скидки')) {
        response = lang === 'uz' ? 'Hozirda chegirmalar yo‘q.' : 'На данный момент скидок нет.';
    } else if (lowerMessage.includes('mahsulot mavjudligi') || lowerMessage.includes('наличие товара')) {
        const productName = lowerMessage.replace(/(mahsulot mavjudligi|наличие товара)/i, '').trim();
        const product = products.find(p => p.name.toLowerCase().includes(productName));
        if (product) {
            response = lang === 'uz' ? `${product.name} omborda ${product.stock} dona mavjud.` : 
                                    `${product.name} в наличии ${product.stock} шт.`;
        } else {
            response = lang === 'uz' ? 'Mahsulot topilmadi!' : 'Товар не найден!';
        }
    } else if (lowerMessage.includes('to‘lov holati') || lowerMessage.includes('статус оплаты')) {
        response = lang === 'uz' ? 'To‘lov holatini tekshirish uchun buyurtma ID raqamini kiriting.' : 
                                'Для проверки статуса оплаты введите ID заказа.';
    } else if (lowerMessage.includes('shikoyat') || lowerMessage.includes('жалоба')) {
        response = lang === 'uz' ? 'Shikoyatingizni SavdoGo@gmail.com manziliga yuboring.' : 
                                'Отправьте вашу жалобу на SavdoGo@gmail.com.';
    } else if (lowerMessage.includes('kategoriyalar') || lowerMessage.includes('категории')) {
        response = [...new Set(products.map(p => p.category))].map(category => 
            `<a href="#" onclick="filterByCategory('${category}')">${category}</a>`
        ).join('<br>');
    } else if (lowerMessage.includes('eng arzon') || lowerMessage.includes('самый дешевый')) {
        const cheapestProduct = products.reduce((min, p) => p.price < min.price ? p : min, products[0]);
        response = `
            <strong>${cheapestProduct.name}</strong><br>
            ${lang === 'uz' ? 'Narx' : 'Цена'}: ${cheapestProduct.price.toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m
        `;
    } else if (lowerMessage.includes('savatni tozalash') || lowerMessage.includes('очистить корзину')) {
        cart = [];
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCart();
        displayProducts(currentCategory);
        response = lang === 'uz' ? 'Savat tozalandi!' : 'Корзина очищена!';
    } else if (lowerMessage.includes('ishlash uchun bog‘lanish') || lowerMessage.includes('связь для работы')) {
        response = lang === 'uz' ? 'Ishlash uchun SavdoGo@gmail.com manziliga yozing.' : 
                                'Для работы пишите на SavdoGo@gmail.com.';
    } else if (lowerMessage.includes('promokod') || lowerMessage.includes('промокод')) {
        response = lang === 'uz' ? 'Hozirda faol promokodlar yo‘q.' : 'На данный момент активных промокодов нет.';
    } else if (lowerMessage.includes('mahsulot solishtirish') || lowerMessage.includes('сравнение товаров')) {
        response = lang === 'uz' ? 'Mahsulotlarni solishtirish uchun ikkita mahsulot nomini kiriting.' : 
                                'Для сравнения товаров введите названия двух товаров.';
    } else if (lowerMessage.includes('sayt foydalanish qo‘llanmasi') || lowerMessage.includes('руководство по сайту')) {
        response = lang === 'uz' ? 'Sayt foydalanish qo‘llanmasi uchun "Biz haqimizda" sahifasini ko‘ring.' : 
                                'Руководство по использованию сайта смотрите на странице "О нас".';
    } else if (lowerMessage.includes('buyurtma bekor qilish') || lowerMessage.includes('отмена заказа')) {
        response = lang === 'uz' ? 'Buyurtmani bekor qilish uchun buyurtma ID raqamini kiriting.' : 
                                'Для отмены заказа введите ID заказа.';
    } else if (lowerMessage.includes('mahsulot sifati') || lowerMessage.includes('качество товара')) {
        response = lang === 'uz' ? 'Barcha mahsulotlar sifatli va kafolatlangan.' : 
                                'Все товары качественные и имеют гарантию.';
    } else if (lowerMessage.includes('smartfonlar') || lowerMessage.includes('смартфоны')) {
        const smartphones = products.filter(p => p.category === 'Elektronika' && p.name.toLowerCase().includes('smartfon'));
        response = smartphones.length > 0 ? smartphones.map(p => 
            `${p.name} - ${p.price.toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m`
        ).join('<br>') : (lang === 'uz' ? 'Smartfonlar topilmadi!' : 'Смартфоны не найдены!');
    } else if (lowerMessage.includes('mashinalar') || lowerMessage.includes('автомобили')) {
        const cars = products.filter(p => p.category === 'Mashina');
        response = cars.length > 0 ? cars.map(p => 
            `${p.name} - ${p.price.toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m`
        ).join('<br>') : (lang === 'uz' ? 'Mashinalar topilmadi!' : 'Автомобили не найдены!');
    } else {
        response = fallbackResponses[lang].notFound;
    }

    addChatbotMessage(response, 'bot');
}

// Chatbot xabarini qo'shish
function addChatbotMessage(text, type) {
    chatHistory.push({ text, type });
    updateChatbotMessages();
}

// Dastlabki yuklash
document.addEventListener('DOMContentLoaded', () => {
    displayProducts();
    updateCart();
    updateLang();
    const savedPlatformColor = localStorage.getItem('platformColor') || '#ffffff'; // Oq rang dastlabki
    changePlatformColor(savedPlatformColor);
    const savedMainBgColor = localStorage.getItem('mainBgColor') || '#f5f5f5'; // Asosiy fon uchun default
    changeMainBgColor(savedMainBgColor);
    const savedCartColor = localStorage.getItem('cartColor') || '#e0f7fa'; // Savatcha uchun default
    changeCartColor(savedCartColor);
    if (isCartButtonActive) {
        document.querySelector('.cart-btn').classList.add('active');
    }
});
</script>
</body>
</html>